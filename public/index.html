<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chatroom v3afSS<title>
  <style>
    /* ======== VARIABLES Y TEMAS ======== */
    :root {
      --bg-main: #121212;
      --panel-bg: #2d2d2d;
      --inset-bg: #1e1e1e;
      --text-color: #dfdfdf;
      --border-light: #454545;
      --border-dark: #000000;
      --accent-blue: #7aa2f7;
      --accent-red: #f7768e;
      --input-bg: #000;
    }

    .light-theme {
      --bg-main: #c0c0c0;
      --panel-bg: #d4d0c8;
      --inset-bg: #ffffff;
      --text-color: #000000;
      --border-light: #ffffff;
      --border-dark: #808080;
      --accent-blue: #000080;
      --accent-red: #800000;
      --input-bg: #fff;
    }

    body {
      margin: 0; font-family: "Courier New", Courier, monospace;
      height: 100vh; background-color: var(--bg-main); color: var(--text-color);
      font-size: 14px; overflow: hidden;
    }

    #mainWrapper { width: 100%; height: 100%; display: flex; padding: 4px; box-sizing: border-box; gap: 4px; }

    /* Bordes Retro Estilo Windows */
    .retro-border {
      border: 2px solid;
      border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
    }

    #sidebar { width: 220px; display: flex; flex-direction: column; padding: 5px; background: var(--panel-bg); }
    #user-list { flex: 1; overflow-y: auto; background: var(--inset-bg); border: 2px inset var(--border-dark); }
    
    .user-entry { display: flex; align-items: center; padding: 3px; font-size: 13px; }
    .user-pfp-small, .msg-avatar { 
      width: 16px; height: 16px; margin-right: 5px; 
      border: 1px solid var(--border-dark); object-fit: cover; 
    }

    #chat-container { flex: 1; display: flex; flex-direction: column; padding: 5px; background: var(--panel-bg); gap: 5px; }
    #messages { flex: 1; overflow-y: auto; background: var(--inset-bg); padding: 8px; border: 2px inset var(--border-dark); }

    .message { margin-bottom: 3px; display: flex; align-items: flex-start; }
    .nameAdmin { color: var(--accent-red); font-weight: bold; }
    .nameNormal { color: var(--accent-blue); font-weight: bold; }
    .systemMsg { color: #888; font-style: italic; font-size: 12px; white-space: pre-wrap; }

    /* Controles */
    #input-container { display: flex; flex-direction: column; gap: 4px; }
    #msgBox { 
      width: 100%; background: var(--input-bg); color: var(--text-color); 
      border: 2px inset var(--border-dark); padding: 4px; resize: none; font-family: inherit;
    }
    .action-bar { display: flex; justify-content: space-between; }
    
    .retro-btn {
      background: var(--panel-bg); color: var(--text-color); font-family: inherit;
      border: 2px solid; border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
      padding: 3px 10px; cursor: pointer; font-size: 12px; font-weight: bold;
    }
    .retro-btn:active { border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark); }

    .hidden { display: none; }
  </style>
</head>
<body>

<div id="mainWrapper">
  <div id="sidebar" class="retro-border">
    <div style="background: #444; color: white; padding: 2px 5px; font-size: 11px; margin-bottom: 4px; border: 1px inset #222;">Users Online:</div>
    <div id="user-list"></div>
    
    <div style="margin-top: 5px; border-top: 1px solid var(--border-dark); padding-top: 5px; display: flex; flex-direction: column; gap: 3px;">
      <input type="file" id="avatarInput" style="font-size: 9px; color: var(--text-color);">
      <button id="changeAvatarBtn" class="retro-btn">Update PFP</button>
      <button id="logoutBtn" class="retro-btn">Exit</button>
    </div>
  </div>

  <div id="chat-container" class="retro-border">
    <div id="messages"></div>
    <div id="input-container">
      <div style="font-size: 11px;">Message to send:</div>
      <textarea id="msgBox" rows="2"></textarea>
      <div class="action-bar">
        <button id="sendBtn" class="retro-btn">Send Message</button>
        <button id="themeToggle" class="retro-btn">ðŸŒ“ Theme</button>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const username = localStorage.getItem("username");
  const rol = localStorage.getItem("rol");

  // --- TEMA ---
  const themeBtn = document.getElementById("themeToggle");
  themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("light-theme");
    localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
  });
  if(localStorage.getItem("theme") === "light") document.body.classList.add("light-theme");

  // --- SOCKETS ---
  socket.emit("join-room", { room: "chat", username, rol }, (res) => {
    if (!res.ok) { location.href = "/login.html"; return; }
    res.history.forEach(addMessage);
  });

  socket.on("new-message", addMessage);
  socket.on("system-message", addMessage);
  socket.on("user-list", renderUserList);
  socket.on("clear-chat", () => document.getElementById("messages").innerHTML = "");

  function renderUserList(users) {
    const side = document.getElementById("user-list");
    side.innerHTML = "";
    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "user-entry";
      // AÃ±adimos un timestamp para evitar cache de imagen
      const imgPath = `/avatar/${u.avatarId || 'default.png'}?t=${Date.now()}`;
      div.innerHTML = `<img src="${imgPath}" class="user-pfp-small">
                       <span style="color:${u.rol==='admin'?'var(--accent-red)':'var(--accent-blue)'}">${u.username}</span>`;
      side.appendChild(div);
    });
  }

  function addMessage(m) {
    const box = document.getElementById("messages");
    const line = document.createElement("div");
    line.className = "message";
    const time = m.time ? new Date(m.time).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" }) : "";

    if (!m.user || m.system) {
      line.innerHTML = `<div class="systemMsg">${m.text}</div>`;
      if (m.imageUrl) {
        line.innerHTML += `<img src="${m.imageUrl}" style="max-width:150px; border:1px solid #444; display:block; margin:4px 0;">`;
      }
    } else {
      const nameClass = m.rol === "admin" ? "nameAdmin" : "nameNormal";
      line.innerHTML = `
        <img src="/avatar/${m.avatarId || 'default.png'}" class="msg-avatar">
        <b class="${nameClass}">${m.user}:</b>
        <span class="msgText">${m.text}</span>
        <span style="font-size:9px; opacity:0.4; margin-left:8px;">${time}</span>
      `;
    }

    box.appendChild(line);
    box.scrollTop = box.scrollHeight;
  }

  // --- ENVIAR ---
  function sendMsg() {
    const box = document.getElementById("msgBox");
    if (!box.value.trim()) return;
    socket.emit("send-message", box.value.trim());
    box.value = "";
  }

  document.getElementById("sendBtn").addEventListener("click", sendMsg);
  document.getElementById("msgBox").addEventListener("keypress", e => {
    if(e.key === "Enter") { e.preventDefault(); sendMsg(); }
  });

  // --- ACTUALIZAR AVATAR ---
  document.getElementById("changeAvatarBtn").addEventListener("click", async () => {
    const fileInput = document.getElementById("avatarInput");
    if (!fileInput.files.length) return alert("Select an image first");

    const formData = new FormData();
    formData.append("avatar", fileInput.files[0]);
    formData.append("username", username);

    try {
      const res = await fetch("/upload-avatar", { method: "POST", body: formData });
      const data = await res.json();
      if (data.ok) {
        alert("Avatar updated!");
        fileInput.value = ""; // Limpiar input
        // El servidor ya emite 'user-list' al actualizar, 
        // por lo que renderUserList se ejecutarÃ¡ automÃ¡ticamente.
      } else {
        alert("Error uploading image");
      }
    } catch (e) {
      console.error(e);
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    location.href = "/login.html";
  });
</script>
</body>
</html>
